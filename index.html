<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Assistant - ผู้ช่วยนัดหมายอัจฉริยะ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i data-lucide="calendar" class="text-white w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">Calendar Assistant</h1>
        </div>
        <button id="toggleViewBtn" onclick="toggleView()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full transition-all text-sm font-medium">
            <i data-lucide="plus" id="toggleIcon" class="w-4 h-4"></i>
            <span id="toggleText">นัดหมายใหม่</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden flex flex-col md:flex-row max-w-6xl mx-auto w-full p-4 gap-4">
        
        <!-- Chat Section -->
        <div id="chatSection" class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border overflow-hidden flex">
            <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <!-- Messages will be injected here -->
            </div>

            <!-- Typing Indicator (Hidden by default) -->
            <div id="typingIndicator" class="hidden px-4 py-2 bg-white">
                <div class="flex justify-start">
                    <div class="bg-slate-100 p-3 rounded-2xl rounded-tl-none flex items-center gap-2 text-slate-400">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                        <span class="text-xs font-medium">Assistant กำลังพิมพ์...</span>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t bg-slate-50">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="userInput"
                        placeholder="ถามคำแนะนำการนัดหมายที่นี่..."
                        class="flex-1 bg-white border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="if(event.key === 'Enter') handleSend()"
                    >
                    <button 
                        onclick="handleSend()"
                        id="sendBtn"
                        class="bg-blue-600 p-2 rounded-full text-white hover:bg-blue-700 transition-colors"
                    >
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Section (Form and List) -->
        <div id="sidebarSection" class="w-full md:w-80 flex flex-col gap-4 hidden md:flex">
            
            <!-- Appointment Form -->
            <div id="formContainer" class="bg-white p-5 rounded-2xl shadow-sm border shrink-0">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="calendar-days" class="text-blue-600 w-5 h-5"></i>
                    ระบุรายละเอียดนัด
                </h2>
                <form id="appointmentForm" onsubmit="handleAddAppointment(event)" class="space-y-3">
                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">หัวข้อ</label>
                        <input required id="formTitle" type="text" class="w-full border rounded-lg p-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="เช่น ประชุมทีมประจำสัปดาห์">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">วันที่</label>
                            <input required id="formDate" type="date" class="w-full border rounded-lg p-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">เวลา</label>
                            <input required id="formTime" type="time" class="w-full border rounded-lg p-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">รายละเอียด (ระบุได้)</label>
                        <textarea id="formDesc" rows="2" class="w-full border rounded-lg p-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition-colors text-sm shadow-md shadow-green-100">
                        ยืนยันการนัดหมาย
                    </button>
                </form>
            </div>

            <!-- List Section -->
            <div class="flex-1 bg-white p-5 rounded-2xl shadow-sm border overflow-hidden flex flex-col">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="clock" class="text-blue-600 w-5 h-5"></i>
                    รายการนัดหมาย
                </h2>
                <div id="appointmentList" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                    <!-- Appointments will be injected here -->
                    <p class="text-slate-400 text-xs text-center italic py-10">ยังไม่มีการนัดหมาย</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-100 py-3 text-center text-[10px] text-slate-400 shrink-0">
        AI-Powered Calendar Assistant • สร้างขึ้นเพื่อช่วยจัดการเวลาของคุณ
    </footer>

    <script>
        // --- State Management ---
        const apiKey = ""; // API Key provided by environment
        let messages = [
            { id: 1, role: 'bot', text: 'สวัสดีครับ! ผมคือผู้ช่วยนัดหมายอัจฉริยะ คุณต้องการให้นัดหมายเรื่องอะไร หรืออยากให้ผมช่วยแนะนำเวลาที่เหมาะสมไหมครับ?' }
        ];
        let appointments = [];
        let isShowFormMode = false;

        // --- Core Functions ---
        
        async function fetchGeminiResponse(userPrompt) {
            const systemInstruction = `You are a helpful Calendar Assistant. Help users plan their appointments. 
            Give advice on scheduling, suggest durations for different tasks (e.g., 30 mins for coffee, 1 hour for meeting). 
            Keep responses concise and in Thai language. If user wants to schedule, encourage them to use the form.`;

            const fetchWithRetry = async (retries = 0) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (err) {
                    if (retries < 5) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(retries + 1);
                    }
                    throw err;
                }
            };
            return fetchWithRetry();
        }

        async function handleSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;

            // Add user message
            messages.push({ id: Date.now(), role: 'user', text });
            input.value = '';
            renderMessages();
            
            // Show typing indicator
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('hidden');
            document.getElementById('sendBtn').disabled = true;

            try {
                const responseText = await fetchGeminiResponse(text);
                messages.push({ id: Date.now() + 1, role: 'bot', text: responseText });
            } catch (error) {
                messages.push({ id: Date.now() + 1, role: 'bot', text: 'ขออภัยครับ เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง' });
            } finally {
                indicator.classList.add('hidden');
                document.getElementById('sendBtn').disabled = false;
                renderMessages();
            }
        }

        function handleAddAppointment(event) {
            event.preventDefault();
            const title = document.getElementById('formTitle').value;
            const date = document.getElementById('formDate').value;
            const time = document.getElementById('formTime').value;
            const description = document.getElementById('formDesc').value;

            const newApp = { id: Date.now(), title, date, time, description };
            appointments.push(newApp);
            
            // Success message in chat
            messages.push({ 
                id: Date.now() + 2, 
                role: 'bot', 
                text: `บันทึกการนัดหมาย "${title}" เรียบร้อยแล้วครับ! คุณสามารถกดดูรายการในแถบรายการนัดหมายได้เลย` 
            });

            // Reset form and view
            document.getElementById('appointmentForm').reset();
            if (window.innerWidth < 768) toggleView(); // Auto toggle back on mobile
            
            renderMessages();
            renderAppointments();
        }

        function deleteAppointment(id) {
            appointments = appointments.filter(app => app.id !== id);
            renderAppointments();
        }

        function generateGoogleCalendarUrl(app) {
            const title = encodeURIComponent(app.title);
            const details = encodeURIComponent(app.description || '');
            const dateStr = app.date.replace(/-/g, '');
            const timeStr = app.time.replace(/:/g, '');
            const start = `${dateStr}T${timeStr}00`;
            // Default 1 hour duration
            const hour = parseInt(app.time.split(':')[0]);
            const endHour = (hour + 1).toString().padStart(2, '0');
            const end = `${dateStr}T${endHour}${app.time.split(':')[1]}00`;
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}`;
        }

        // --- UI Rendering ---

        function renderMessages() {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = messages.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] p-3 rounded-2xl ${
                        m.role === 'user' 
                        ? 'bg-blue-600 text-white rounded-tr-none shadow-sm' 
                        : 'bg-slate-100 text-slate-800 rounded-tl-none border border-slate-200'
                    }">
                        <p class="text-sm whitespace-pre-wrap">${m.text}</p>
                    </div>
                </div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function renderAppointments() {
            const list = document.getElementById('appointmentList');
            if (appointments.length === 0) {
                list.innerHTML = `<p class="text-slate-400 text-xs text-center italic py-10">ยังไม่มีการนัดหมาย</p>`;
                return;
            }

            list.innerHTML = appointments.map(app => `
                <div class="group relative bg-slate-50 border border-slate-100 p-3 rounded-xl hover:border-blue-200 transition-all shadow-sm">
                    <button onclick="deleteAppointment(${app.id})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <h3 class="text-sm font-bold text-slate-800 pr-5">${app.title}</h3>
                    <p class="text-xs text-blue-600 font-medium mt-1">${app.date} • ${app.time}</p>
                    <a href="${generateGoogleCalendarUrl(app)}" target="_blank" rel="noopener noreferrer" class="mt-2 inline-flex items-center gap-1 text-[10px] bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-100 text-slate-600">
                        <i data-lucide="external-link" class="w-2.5 h-2.5"></i> เพิ่มใน Google Calendar
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function toggleView() {
            const chatSection = document.getElementById('chatSection');
            const sidebarSection = document.getElementById('sidebarSection');
            const btnText = document.getElementById('toggleText');
            const btnIcon = document.getElementById('toggleIcon');
            const formContainer = document.getElementById('formContainer');

            isShowFormMode = !isShowFormMode;

            if (window.innerWidth < 768) {
                if (isShowFormMode) {
                    chatSection.classList.add('hidden');
                    sidebarSection.classList.remove('hidden');
                    btnText.innerText = "กลับไปที่แชท";
                    btnIcon.setAttribute('data-lucide', 'message-square');
                } else {
                    chatSection.classList.remove('hidden');
                    sidebarSection.classList.add('hidden');
                    btnText.innerText = "นัดหมายใหม่";
                    btnIcon.setAttribute('data-lucide', 'plus');
                }
            } else {
                // Desktop toggle logic (show/hide form container specifically)
                // Just for aesthetics, we can show/hide form if needed
                // Currently, desktop shows both, but btn can act as a jump or reset
            }
            lucide.createIcons();
        }

        // --- Init ---
        window.onload = () => {
            renderMessages();
            renderAppointments();
            lucide.createIcons();
        };
    </script>
</body>
</html>
